---
title: "Application reports"
author: "MyAI"
date: '`r format(Sys.Date(), "%b %d %Y", tz="Africa/Bissau")`'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, results = 'hide')
```

```{r}
library(dplyr)
library(RMySQL)
library(RJDBC)
library(knitr)
library(ggplot2)
```

```{r}

#sQL for MySQL
query_mysql <- "SELECT CASE A.MODULE WHEN 'BUNDLES3G' then 'BUNDLES3G_EVD_123' ELSE A.MODULE END MODULE, C.TOTAL SDLW, B.TOTAL YESTERDAY, A.TOTAL TODAY, (A.TOTAL - B.TOTAL) Y_T_DIFF, CONCAT(ROUND(A.TOTAL*100/(B.TOTAL), 1)-100, '%') PCT_Y_T, (A.TOTAL - C.TOTAL) DIFF_SDLW, CONCAT(ROUND(A.TOTAL*100/(C.TOTAL), 1)-100, '%') PCT_SDLW
FROM (SELECT MODULE, COUNT(DISTINCT MSISDN) DIST ,COUNT(BUNDLE_PRICE) NBRE, SUM(BUNDLE_PRICE) TOTAL FROM COMMON.CDR
WHERE TRANSDATE = CURDATE() AND STATUS_REASON = 'BUNDLE_SUCCESS' AND LAST_UPDATE <= current_timestamp() GROUP BY MODULE) A 
LEFT JOIN (SELECT MODULE, COUNT(DISTINCT MSISDN)DIST,COUNT(BUNDLE_PRICE) NBRE, SUM(BUNDLE_PRICE) TOTAL FROM COMMON.CDR
WHERE TRANSDATE = date_sub(CURDATE(), INTERVAL 1 DAY) AND STATUS_REASON = 'BUNDLE_SUCCESS' AND LAST_UPDATE <= date_sub(current_timestamp(), interval 1 day)
GROUP BY MODULE) B USING (MODULE) 
LEFT JOIN (SELECT MODULE, COUNT(DISTINCT MSISDN)DIST,COUNT(BUNDLE_PRICE) NBRE, SUM(BUNDLE_PRICE) TOTAL FROM COMMON.CDR
WHERE TRANSDATE = date_sub(CURDATE(), INTERVAL 7 DAY) AND STATUS_REASON = 'BUNDLE_SUCCESS' AND LAST_UPDATE <= date_sub(current_timestamp(), INTERVAL 7 day)
GROUP BY MODULE) C USING (MODULE)
ORDER BY TODAY DESC"

#SQL for oracle
query_orcl <- "SELECT MODULE, C.TOTAL SDLW, B.TOTAL YESTERDAY, A.TOTAL TODAY, (A.TOTAL - B.TOTAL) Y_T_DIFF, CONCAT(ROUND(A.TOTAL*100/(B.TOTAL), 1)-100, '%') PCT_Y_T, (A.TOTAL - C.TOTAL) DIFF_SDLW, CONCAT(ROUND(A.TOTAL*100/(C.TOTAL), 1)-100, '%') PCT_SDLW
FROM (SELECT MODULE, COUNT(DISTINCT MSISDN) DIST ,COUNT(BUNDLE_PRICE) NBRE, SUM(BUNDLE_PRICE) TOTAL FROM CDR
WHERE TRANSDATE = trunc(sysdate) AND STATUS_REASON = 'BUNDLE_SUCCESS' AND LAST_UPDATE <= sysdate GROUP BY MODULE) A 
LEFT JOIN (SELECT MODULE, COUNT(DISTINCT MSISDN)DIST,COUNT(BUNDLE_PRICE) NBRE, SUM(BUNDLE_PRICE) TOTAL FROM CDR
WHERE TRANSDATE = trunc(sysdate-1) AND STATUS_REASON = 'BUNDLE_SUCCESS' AND LAST_UPDATE <= sysdate-1
GROUP BY MODULE) B USING (MODULE) 
LEFT JOIN (SELECT MODULE, COUNT(DISTINCT MSISDN)DIST,COUNT(BUNDLE_PRICE) NBRE, SUM(BUNDLE_PRICE) TOTAL FROM CDR
WHERE TRANSDATE = trunc(sysdate-7) AND STATUS_REASON = 'BUNDLE_SUCCESS' AND LAST_UPDATE <= sysdate-7
GROUP BY MODULE) C USING (MODULE) 
ORDER BY TODAY DESC"

#Connection to server 39
myDB39 <- dbConnect(MySQL(), user='everaldo', password='123456', dbname='COMMON', host='192.168.100.39')
rs39 <- dbSendQuery(myDB39, query_mysql)
data39 <- fetch(rs39, n=-1)


#Connection to server 15
myDB15 <- dbConnect(MySQL(), user='mtn', password='Mtn@123456', dbname='COMMON', host='192.168.100.15')
rs15 <- dbSendQuery(myDB15, query_mysql)
data15 <- fetch(rs15, n=-1)

#Connection to oracle server
drv <- JDBC("oracle.jdbc.OracleDriver", classPath = "lib/ojdbc6.jar")
orcl <- dbConnect(drv, "jdbc:oracle:thin:@//10.100.2.179:1521/vasdb", "vas", "vas")
dataOrcl <- dbGetQuery(orcl, query_orcl)

#bind dataframes
df <- rbind(data39, data15, dataOrcl)
rm(data39, data15, dataOrcl)

#Mutate final sdf and add datetime
df1 <- df %>% 
  #select() %>% 
  #filter(MODULE != c('ECOMIB', 'SMSBUNDLE')) %>% 
  arrange(desc(TODAY)) %>%
  mutate_if(~any(is.numeric(.)), ~prettyNum(., big.mark = ","))

#Get Hourly trend
query_hist_orcl <- "select module, transdate, to_char(last_update, 'HH24') hourly, sum(bundle_price) total from cdr where transdate >= trunc(sysdate-1) and status_reason = 'BUNDLE_SUCCESS' group by module, transdate, to_char(last_update, 'HH24') 
UNION ALL
select module, transdate, to_char(last_update, 'HH24') hourly, sum(bundle_price) total from cdr where transdate = trunc(sysdate-7) and status_reason = 'BUNDLE_SUCCESS' group by module, transdate, to_char(last_update, 'HH24')
order by 1, 2, 3"


query_hist_mysql39 <- "SELECT MODULE, TRANSDATE, HOUR(LAST_UPDATE) HOURLY, SUM(BUNDLE_PRICE) TOTAL FROM CDR WHERE TRANSDATE >= CURDATE()-1 AND STATUS_REASON = 'BUNDLE_SUCCESS' AND MODULE LIKE '%WAUU%'
GROUP BY MODULE, TRANSDATE, HOUR(LAST_UPDATE)
UNION ALL
SELECT MODULE, TRANSDATE, HOUR(LAST_UPDATE) HOURLY, SUM(BUNDLE_PRICE) TOTAL FROM CDR WHERE TRANSDATE = CURDATE()-7 AND STATUS_REASON = 'BUNDLE_SUCCESS' AND MODULE LIKE '%WAUU%'
GROUP BY MODULE, TRANSDATE, HOUR(LAST_UPDATE) ORDER BY 1, 2, 3"

rs39_1 <- dbSendQuery(myDB39, query_hist_mysql39)
data_hist_m39 <- fetch(rs39_1, n=-1)
data_hist_m39$TRANSDATE <- as.character(as.Date(data_hist_m39$TRANSDATE))


data_hist_orcl <- dbGetQuery(orcl, query_hist_orcl)
data_hist_orcl$TRANSDATE <- as.character(as.Date(data_hist_orcl$TRANSDATE))


```

#### Application Reports summary `r format(Sys.time(), "%a %b %d/%Y %X ", tz="Africa/Bissau")`

`r kable(df1)`

#### Labels definition
- **SDLW** = Total revenue same hour for Last week same day
- **YESTERDAY** = Total revenue same hour for yesterday
- **TODAY** = Total revenue today up this time
- **Y_T_DIFF** = Difference of total revenue between yesterday and today
- **PCT_Y_T** = Percentage of total revenue between yesterday and today
- **DIFF_SDLW** = Difference of total revenue between same day last week and today
- **PCT_SDLW** = Percentage of total revenue between same day last week and today



---

- *Total Yesterday* **`r prettyNum(sum(df$YESTERDAY, na.rm=T), big.mark = ",")`**
- *Total Today* **`r prettyNum(sum(df$TODAY, na.rm=T), big.mark = ",")`**
- *Total Difference Yest 2 Today* **`r prettyNum(sum(df$TODAY, na.rm=T) - sum(df$YESTERDAY, na.rm=T), big.mark = ",")`**
- *Total Difference SDLW 2 Today* **`r prettyNum(sum(df$TODAY, na.rm=T) - sum(df$SDLW, na.rm=T), big.mark = ",")`**

---



#### Applicaton reports chart per bundle

```{r}
df_data <- data_hist_orcl %>% filter(MODULE=='BUNDLES3G')
ggplot(df_data, aes(x=HOURLY, y=TOTAL, group=TRANSDATE))+geom_line(aes(color=TRANSDATE)) + geom_point(aes(color=TRANSDATE))+ scale_y_continuous(labels = function(x) format(x, scientific = FALSE))+ggtitle("DataBundle trend")
```


```{r}
df_wauu <- data_hist_m39 %>% filter(MODULE=='WAUU')
ggplot(df_wauu, aes(x=HOURLY, y=TOTAL, group=TRANSDATE))+geom_line(aes(color=TRANSDATE)) + geom_point(aes(color=TRANSDATE))+ scale_y_continuous(labels = function(x) format(x, scientific = FALSE))+ggtitle("WAUU trend")
```


```{r}
df_youth <- data_hist_orcl %>% filter(MODULE=='YOUTHv4')
ggplot(df_youth, aes(x=HOURLY, y=TOTAL, group=TRANSDATE))+geom_line(aes(color=TRANSDATE)) + geom_point(aes(color=TRANSDATE))+ scale_y_continuous(labels = function(x) format(x, scientific = FALSE))+ggtitle("YOUTH trend")
```


```{r}
df_bombastico <- data_hist_orcl %>% filter(MODULE=='BOMBASTICO')
ggplot(df_bombastico, aes(x=HOURLY, y=TOTAL, group=TRANSDATE))+geom_line(aes(color=TRANSDATE)) + geom_point(aes(color=TRANSDATE))+ scale_y_continuous(labels = function(x) format(x, scientific = FALSE))+ggtitle("Bombastico trend")
```


```{r}
#Clear resultset and close connections
rm(df, df1)
dbClearResult(dbListResults(myDB15)[[1]])
dbClearResult(dbListResults(myDB39)[[1]])
dbDisconnect(myDB15)
dbDisconnect(myDB39)
dbDisconnect(orcl)
```